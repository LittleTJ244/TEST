<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中1英語 Unit 6 完璧マスターDX + Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            user-select: none;
        }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 並べ替え問題用のスタイル */
        .sortable-word {
            transition: all 0.2s;
            cursor: pointer;
        }
        .sortable-word:active { transform: scale(0.95); }
        .word-selected { opacity: 0.5; pointer-events: none; }
        
        .btn-bounce:active { transform: scale(0.95); }

        /* ローディングアニメーション */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* AI解説ボックスのアニメーション */
        .ai-box-enter {
            animation: slideDown 0.4s ease-out forwards;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); max-height: 0; }
            to { opacity: 1; transform: translateY(0); max-height: 500px; }
        }
        
        .gemini-gradient-text {
            background: linear-gradient(90deg, #4285F4, #9B72CB, #D96570);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gemini-gradient-bg {
            background: linear-gradient(90deg, #eff6ff, #fbf7ff);
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen flex items-center justify-center p-2 sm:p-4">

    <!-- Main Container -->
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden relative flex flex-col" style="height: 700px;">
        
        <!-- Header -->
        <div class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md z-20">
            <h1 class="text-lg font-bold"><i class="fas fa-graduation-cap mr-2"></i>Unit 6 マスターDX</h1>
            <div class="text-sm font-light">Score: <span id="header-score">0</span></div>
        </div>

        <!-- Scrollable Content Area -->
        <div class="flex-grow overflow-y-auto relative bg-gray-50">

            <!-- 1. Start Screen (Mode Selection) -->
            <div id="start-screen" class="p-6 flex flex-col items-center justify-center min-h-full space-y-4">
                <div class="text-center mb-2">
                    <div class="inline-block p-4 bg-indigo-100 rounded-full text-indigo-600 text-4xl mb-2">
                        <i class="fas fa-book-reader"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">特訓モード選択</h2>
                </div>

                <div class="w-full space-y-3">
                    <button onclick="startQuiz('vocab')" class="btn-bounce w-full bg-white border-l-4 border-green-500 p-3 rounded-lg shadow hover:shadow-md transition flex items-center justify-between group">
                        <div>
                            <div class="font-bold text-base text-gray-800">単語・熟語コース</div>
                            <div class="text-xs text-gray-500">基本単語と連語をチェック</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-green-500"></i>
                    </button>

                    <button onclick="startQuiz('grammar')" class="btn-bounce w-full bg-white border-l-4 border-blue-500 p-3 rounded-lg shadow hover:shadow-md transition flex items-center justify-between group">
                        <div>
                            <div class="font-bold text-base text-gray-800">文法・穴埋めコース</div>
                            <div class="text-xs text-gray-500">3単現のs、疑問文、否定文</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-blue-500"></i>
                    </button>

                    <button onclick="startQuiz('sort')" class="btn-bounce w-full bg-white border-l-4 border-orange-500 p-3 rounded-lg shadow hover:shadow-md transition flex items-center justify-between group">
                        <div>
                            <div class="font-bold text-base text-gray-800">並べ替え特訓コース</div>
                            <div class="text-xs text-gray-500">テストで差がつく英作文</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-300 group-hover:text-orange-500"></i>
                    </button>
                    
                    <button onclick="startQuiz('all')" class="btn-bounce w-full bg-indigo-50 border border-indigo-200 p-3 rounded-lg shadow-sm hover:shadow-md transition flex items-center justify-center">
                        <div class="font-bold text-base text-indigo-700"><i class="fas fa-crown mr-2"></i>総合テスト (全30問)</div>
                    </button>

                    <!-- New AI Feature Button -->
                    <button onclick="startAIInfiniteMode()" class="btn-bounce w-full bg-gradient-to-r from-purple-600 to-pink-500 text-white p-4 rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center relative overflow-hidden group mt-4">
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition duration-300"></div>
                        <div class="text-center">
                            <div class="font-bold text-lg"><i class="fas fa-magic mr-2"></i>AI無限演習モード</div>
                            <div class="text-xs opacity-90">Geminiが新しい問題を次々生成！</div>
                        </div>
                        <div class="absolute right-4 text-2xl animate-pulse">✨</div>
                    </button>
                </div>
            </div>

            <!-- 2. Quiz Screen -->
            <div id="quiz-screen" class="hidden min-h-full flex flex-col p-4">
                <!-- Progress -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                    <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                
                <!-- Loading State (for AI) -->
                <div id="ai-loading" class="hidden flex-col items-center justify-center py-10">
                    <div class="loader mb-4"></div>
                    <p class="text-indigo-600 font-bold animate-pulse">AIが問題を生成中...</p>
                    <p class="text-xs text-gray-500 mt-2">教科書の内容を分析しています</p>
                </div>

                <!-- Question Area -->
                <div id="question-area">
                    <div class="mb-4">
                        <span id="q-tag" class="inline-block px-2 py-1 text-xs font-bold text-white bg-gray-400 rounded mb-2">TAG</span>
                        <h3 id="question-text" class="text-xl font-bold text-gray-800 leading-relaxed">問題文</h3>
                    </div>

                    <!-- A. Multiple Choice Container -->
                    <div id="choice-container" class="space-y-3 hidden">
                        <!-- Buttons injected via JS -->
                    </div>

                    <!-- B. Sorting (Scramble) Container -->
                    <div id="sort-container" class="flex-col hidden h-full">
                        <!-- Answer Box -->
                        <div class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-4 min-h-[80px] mb-4 flex flex-wrap gap-2 items-center" id="sort-answer-area">
                            <span class="text-gray-400 text-sm w-full text-center pointer-events-none" id="sort-placeholder">単語をタップして並べよう</span>
                        </div>
                        
                        <!-- Word Bank -->
                        <div class="flex flex-wrap gap-2 justify-center mb-6" id="sort-word-bank">
                            <!-- Word chips injected via JS -->
                        </div>

                        <!-- Reset & Submit Buttons -->
                        <div class="mt-auto grid grid-cols-4 gap-2">
                            <button onclick="resetSort()" class="col-span-1 bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-3 rounded-lg">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button onclick="checkSortAnswer()" class="col-span-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg">
                                回答する
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Result Screen -->
            <div id="result-screen" class="hidden min-h-full flex flex-col items-center justify-center p-6 text-center">
                <div class="mb-6 relative">
                    <svg class="w-32 h-32 transform -rotate-90">
                        <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="12" fill="none" />
                        <circle id="score-circle" cx="64" cy="64" r="56" stroke="#4f46e5" stroke-width="12" fill="none" stroke-dasharray="351" stroke-dashoffset="351" class="transition-all duration-1000" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-3xl font-bold text-gray-800" id="final-score-num">0</span>
                        <span class="text-xs text-gray-500">POINTS</span>
                    </div>
                </div>
                
                <h2 class="text-2xl font-bold mb-2" id="result-title">Title</h2>
                <p class="text-gray-600 mb-8" id="result-msg">Message</p>

                <button onclick="location.reload()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition">
                    トップに戻る
                </button>
            </div>

        </div>

        <!-- Feedback Overlay (Modal) -->
        <div id="feedback-overlay" class="absolute inset-0 bg-white z-50 hidden flex flex-col p-6 fade-in overflow-y-auto">
            <div class="flex-grow flex flex-col items-center pt-8">
                <div id="fb-icon" class="text-6xl mb-4"></div>
                <h2 id="fb-title" class="text-3xl font-bold mb-4"></h2>
                
                <div class="w-full bg-gray-50 p-4 rounded-lg border-l-4 mb-4 relative overflow-hidden" id="fb-content-box">
                    <p class="text-xs text-gray-500 font-bold mb-1">正解</p>
                    <p id="fb-correct-answer" class="text-lg font-bold text-indigo-600 mb-3"></p>
                    <p class="text-xs text-gray-500 font-bold mb-1">簡易解説</p>
                    <p id="fb-explain" class="text-sm text-gray-700 leading-relaxed"></p>
                </div>

                <!-- AI Explain Button -->
                <button id="btn-ask-ai" onclick="askGeminiExplain()" class="w-full bg-gradient-to-r from-purple-100 to-pink-100 border border-purple-200 text-purple-700 font-bold py-3 rounded-xl mb-4 hover:shadow-md transition flex items-center justify-center gap-2">
                    <i class="fas fa-sparkles text-purple-500"></i> AI先生に詳しく聞く
                </button>

                <!-- AI Response Area -->
                <div id="ai-response-area" class="w-full hidden mb-4 text-left">
                    <div class="gemini-gradient-bg p-4 rounded-xl border border-purple-100 shadow-inner">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-robot text-purple-500"></i>
                            <span class="font-bold text-sm gemini-gradient-text">Gemini先生の解説</span>
                        </div>
                        <div id="ai-response-text" class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
                    </div>
                </div>

            </div>
            
            <button id="next-btn" onclick="nextQuestion()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4">
                次へ進む
            </button>
        </div>

    </div>

    <script>
        // API Key for Gemini (Injected by environment)
        const apiKey = "AIzaSyCEuWMwLZ6f4Pq6G_JVuQZa7DphHY_LUbk"; 

        // ==========================================
        // 問題データベース (30問)
        // types: 'choice' (4択), 'sort' (並べ替え)
        // categories: 'vocab', 'grammar', 'reading'
        // ==========================================
        const allQuestions = [
            // --- Part 1: Vocab & Basic Grammar ---
            {
                id: 1, type: 'choice', category: 'vocab',
                q: "「活動的な、活発な」を英語で？",
                options: ["active", "action", "act", "quiet"],
                a: 0,
                explain: "教科書 Part 1より。Tina is very active. (ティナはとても活動的です)"
            },
            {
                id: 2, type: 'choice', category: 'vocab',
                q: "「あきらめる」を英語で？",
                options: ["give up", "get up", "stand up", "go up"],
                a: 0,
                explain: "give up で「あきらめる」。教科書では She never gives up.（彼女は決してあきらめない）と出てきます。"
            },
            {
                id: 3, type: 'choice', category: 'vocab',
                q: "「最近、近頃」を英語で？",
                options: ["these days", "those days", "every day", "someday"],
                a: 0,
                explain: "these days で「最近、この頃」という意味の熟語です。"
            },
            {
                id: 4, type: 'choice', category: 'grammar',
                q: "空欄に入る語は？<br>Tina (    ) a lot of friends.",
                options: ["has", "have", "is", "having"],
                a: 0,
                explain: "主語がTina（3人称単数）なので、have は has に変わります。"
            },
            {
                id: 5, type: 'sort', category: 'grammar',
                q: "並べ替えて日本文に合う英文を作りなさい。<br>「彼女はいつも一生懸命勉強します。」",
                words: ["studies", "She", "hard", "always", "."],
                correctOrder: ["She", "always", "studies", "hard", "."],
                explain: "頻度を表す副詞(always)は、一般動詞(studies)の前に置きます。She always studies hard."
            },
            {
                id: 6, type: 'sort', category: 'grammar',
                q: "並べ替えなさい。<br>「彼女は歌うことと踊ることが好きです。」",
                words: ["likes", "She", "dancing", "singing", "and", "."],
                correctOrder: ["She", "likes", "singing", "and", "dancing", "."],
                explain: "like + ～ing で「～することが好き」。She likes singing..."
            },

            // --- Part 2: Questions & Vocab ---
            {
                id: 7, type: 'choice', category: 'vocab',
                q: "「ほとんど」を英語で？",
                options: ["almost", "always", "also", "about"],
                a: 0,
                explain: "It's almost Christmas. (もうすぐ/ほとんどクリスマスだ)"
            },
            {
                id: 8, type: 'choice', category: 'vocab',
                q: "「風邪をひいている」正しい表現は？",
                options: ["have a cold", "has a hot", "is a cold", "catch cold"],
                a: 0,
                explain: "have a cold で「風邪をひいている」。主語がSheなら has a cold です。"
            },
            {
                id: 9, type: 'sort', category: 'grammar',
                q: "並べ替えなさい。<br>「あなたはクリスマスに何が欲しいですか？」",
                words: ["want", "do", "What", "you", "Christmas", "for", "?"],
                correctOrder: ["What", "do", "you", "want", "for", "Christmas", "?"],
                explain: "What do you want for...? の形を覚えましょう。"
            },
            {
                id: 10, type: 'choice', category: 'grammar',
                q: "正しい答え方は？<br>Does she have a cold?",
                options: ["No, she doesn't.", "No, she don't.", "No, she isn't.", "No, she hasn't."],
                a: 0,
                explain: "Doesで聞かれたら does (doesn't) で答えます。"
            },
            {
                id: 11, type: 'choice', category: 'grammar',
                q: "空欄に入る語は？<br>Where (    ) Tina?",
                options: ["is", "does", "are", "do"],
                a: 0,
                explain: "「Tinaはどこですか？」というbe動詞の文です。Where is Tina?"
            },

            // --- Part 3: Housework & Daily Routine ---
            {
                id: 12, type: 'choice', category: 'vocab',
                q: "「皿を洗う」正しい英語は？",
                options: ["wash the dishes", "wash the dish", "clean the plate", "wash the table"],
                a: 0,
                explain: "dish（皿）は複数枚あるのが普通なので dishes と複数形にします。"
            },
            {
                id: 13, type: 'choice', category: 'vocab',
                q: "「ゴミを出す」正しい英語は？",
                options: ["take out the garbage", "bring the garbage", "take off the garbage", "put the garbage"],
                a: 0,
                explain: "take out ～ で「～を外に出す」。garbage はゴミ。"
            },
            {
                id: 14, type: 'choice', category: 'vocab',
                q: "「テーブルの準備をする（配膳する）」",
                options: ["set the table", "make the table", "get the table", "put the table"],
                a: 0,
                explain: "set the table で「食卓の準備をする」という決まり文句です。"
            },
            {
                id: 15, type: 'choice', category: 'vocab',
                q: "「心配しないで。」",
                options: ["Don't worry.", "Not worry.", "No problem.", "Don't sad."],
                a: 0,
                explain: "Don't worry. は相手を励ます時の重要フレーズ。"
            },
            {
                id: 16, type: 'sort', category: 'grammar',
                q: "並べ替えなさい。<br>「彼女は僕とも遊びません。」",
                words: ["play", "doesn't", "She", "me", "with", ",", "either", "."],
                correctOrder: ["She", "doesn't", "play", "with", "me", ",", "either", "."],
                explain: "否定文の文末につける either は「～も（ない）」という意味。too（～もまた）の否定版です。"
            },
            {
                id: 17, type: 'choice', category: 'grammar',
                q: "空欄に入る語は？<br>She (    ) go to school.",
                options: ["doesn't", "isn't", "don't", "not"],
                a: 0,
                explain: "一般動詞(go)の否定文で、主語がSheなので doesn't を使います。"
            },
            {
                id: 18, type: 'choice', category: 'vocab',
                q: "「彼女は少し疲れています。」",
                options: ["She is a little bit tired.", "She is a lot tired.", "She has tired.", "She is little tired."],
                a: 0,
                explain: "a little bit で「少し」。tired は「疲れている」という状態（形容詞）なので be動詞を使います。"
            },

            // --- 3単現のs 特訓 ---
            {
                id: 19, type: 'choice', category: 'grammar',
                q: "正しい形を選べ。<br>Ken (    ) tennis every Sunday.",
                options: ["plays", "play", "playing", "is play"],
                a: 0,
                explain: "Ken = 3人称単数 → play に s をつける。"
            },
            {
                id: 20, type: 'choice', category: 'grammar',
                q: "正しい形を選べ。<br>My mother (    ) breakfast.",
                options: ["cooks", "cook", "cooking", "is cook"],
                a: 0,
                explain: "My mother = She = 3人称単数 → cooks。"
            },
            {
                id: 21, type: 'choice', category: 'grammar',
                q: "正しい形を選べ。<br>He (    ) TV after dinner.",
                options: ["watches", "watchs", "watch", "watching"],
                a: 0,
                explain: "ch で終わる動詞には es をつけます。watches [ワッチーズ]。"
            },
            {
                id: 22, type: 'choice', category: 'grammar',
                q: "正しい形を選べ。<br>Eri (    ) English hard.",
                options: ["studies", "studys", "study", "studeis"],
                a: 0,
                explain: "「子音字+y」で終わる語は y を i に変えて es。studies。"
            },
            {
                id: 23, type: 'choice', category: 'grammar',
                q: "正しい文を選べ。",
                options: ["Does she like music?", "Do she like music?", "Does she likes music?", "Is she like music?"],
                a: 0,
                explain: "疑問文は Does で始め、動詞は原形(like)に戻ります。"
            },
            
            // --- 応用・総合 ---
            {
                id: 24, type: 'sort', category: 'grammar',
                q: "並べ替えなさい。<br>「私の兄は新しい自転車を持っています。」",
                words: ["has", "brother", "My", "bike", "new", "a", "."],
                correctOrder: ["My", "brother", "has", "a", "new", "bike", "."],
                explain: "have の3単現は has です。"
            },
            {
                id: 25, type: 'choice', category: 'reading',
                q: "教科書内容理解：<br>Ms. Rios says, 'She needs some (    ).'",
                options: ["rest", "test", "best", "nest"],
                a: 0,
                explain: "Part 3の最後、おばあちゃん（Ms. Rios）のセリフ。「彼女には休息が必要です」"
            },
            {
                id: 26, type: 'sort', category: 'grammar',
                q: "並べ替えなさい。<br>「彼女はあまりよく眠れません。」",
                options: [], // sort type needs words
                words: ["doesn't", "well", "sleep", "She", "."],
                correctOrder: ["She", "doesn't", "sleep", "well", "."],
                explain: "well（よく）は文末に置くことが多いです。"
            },
            {
                id: 27, type: 'choice', category: 'vocab',
                q: "「～出身である」",
                options: ["be from", "come to", "go from", "live to"],
                a: 0,
                explain: "I am from Japan. = I come from Japan. "
            },
            {
                id: 28, type: 'choice', category: 'vocab',
                q: "「親愛なる～へ」（手紙やメールの書き出し）",
                options: ["Dear", "Hi", "Hello", "From"],
                a: 0,
                explain: "Dear Grandma, のように使います。"
            },
            {
                id: 29, type: 'sort', category: 'grammar',
                q: "並べ替えなさい。<br>「彼女はオムレツを作ることができます。」",
                words: ["make", "can", "She", "an", "omelet", "."],
                correctOrder: ["She", "can", "make", "an", "omelet", "."],
                explain: "助動詞 can の後ろは動詞の原形です。s はつきません。"
            },
            {
                id: 30, type: 'choice', category: 'grammar',
                q: "正しい文はどっち？",
                options: ["She likes dogs.", "She is like dogs."],
                a: 0,
                explain: "「～が好き」は一般動詞 like を使います。be動詞(is)は混ぜてはいけません。"
            }
        ];

        // ==========================================
        // アプリの状態管理
        // ==========================================
        let currentMode = 'all';
        let questionQueue = [];
        let currentIndex = 0;
        let score = 0;
        let currentSortAnswer = []; // 並べ替え問題の現在の回答リスト
        let currentQuestionData = null; // 現在の問題データ（AI用）
        let userLastSelection = null; // ユーザーの最後の回答（AI解説用）

        // ==========================================
        // 関数
        // ==========================================

        function startQuiz(mode) {
            currentMode = mode;
            score = 0;
            currentIndex = 0;
            document.getElementById('header-score').innerText = 0;

            // フィルタリング
            if (mode === 'all') {
                questionQueue = [...allQuestions];
            } else if (mode === 'sort') {
                questionQueue = allQuestions.filter(q => q.type === 'sort');
            } else if (mode === 'vocab') {
                questionQueue = allQuestions.filter(q => q.category === 'vocab' && q.type === 'choice');
            } else if (mode === 'grammar') {
                questionQueue = allQuestions.filter(q => q.category === 'grammar' && q.type === 'choice');
            }

            // シャッフル（ランダム出題）
            shuffleArray(questionQueue);

            // 画面切り替え
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('result-screen').classList.add('hidden');

            loadQuestion();
        }

        // --- AI無限演習モード開始 ---
        async function startAIInfiniteMode() {
            currentMode = 'ai_infinite';
            score = 0;
            currentIndex = 0;
            questionQueue = []; // キューは空でスタート
            document.getElementById('header-score').innerText = 0;

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            
            // 初回ロード
            await loadAIQuestion();
        }

        async function loadAIQuestion() {
            // UIをローディング状態に
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('ai-loading').classList.remove('hidden');
            document.getElementById('ai-loading').style.display = 'flex';
            document.getElementById('progress-bar').style.width = '100%'; // 無限モードなのでフル表示か、点滅など

            try {
                // Gemini API Call
                const prompt = `
                日本の中学1年生向けの英語の4択問題を作成してください。
                テーマ: 3人称単数現在形, 一般動詞, 疑問詞, 頻度を表す副詞, Unit 6 (Tina's routine).
                難易度: 基礎〜標準
                
                以下のJSON形式のみを出力してください（Markdownのバッククォートは不要）:
                {
                  "q": "問題文（日本語訳や空欄補充など。例:「彼女はテニスが好きですか？」を英語にしなさい）",
                  "options": ["選択肢1", "選択肢2", "選択肢3", "選択肢4"],
                  "a": 正解のインデックス(0-3の整数),
                  "explain": "短い解説（日本語）",
                  "type": "choice",
                  "category": "grammar"
                }`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error("Network error");
                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                
                // Robust JSON extraction
                const aiQ = JSON.parse(text);
                
                // キューに追加して表示
                questionQueue.push(aiQ);
                currentIndex = questionQueue.length - 1; // 常に最新を表示
                
                // UIリセット
                document.getElementById('ai-loading').classList.add('hidden');
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('question-area').classList.remove('hidden');
                
                loadQuestion(true); // isAI = true

            } catch (e) {
                console.error(e);
                alert("AI生成に失敗しました。もう一度試してください。");
                location.reload();
            }
        }

        function loadQuestion(isAI = false) {
            const q = questionQueue[currentIndex];
            currentQuestionData = q; // 現在のデータを保持
            
            const qText = document.getElementById('question-text');
            const qTag = document.getElementById('q-tag');
            const choiceContainer = document.getElementById('choice-container');
            const sortContainer = document.getElementById('sort-container');
            
            // プログレスバー
            if (currentMode !== 'ai_infinite') {
                const percent = ((currentIndex) / questionQueue.length) * 100;
                document.getElementById('progress-bar').style.width = `${percent}%`;
            } else {
                document.getElementById('progress-bar').style.width = `100%`;
                document.getElementById('progress-bar').classList.add('animate-pulse');
            }

            // タグ設定
            let tagText = "";
            let tagColor = "";
            
            if (currentMode === 'ai_infinite') {
                tagText = "AI生成問題 ✨";
                tagColor = "bg-purple-600";
            } else {
                if (q.category === 'vocab') { tagText = "単語・熟語"; tagColor = "bg-green-500"; }
                else if (q.category === 'grammar') { tagText = "文法"; tagColor = "bg-blue-500"; }
                else { tagText = "読解"; tagColor = "bg-purple-500"; }
                if (q.type === 'sort') { tagText = "並べ替え"; tagColor = "bg-orange-500"; }
            }
            
            qTag.textContent = tagText;
            qTag.className = `inline-block px-2 py-1 text-xs font-bold text-white rounded mb-2 ${tagColor}`;
            
            qText.innerHTML = (currentMode === 'ai_infinite' ? `Q.${score + 1} ` : `Q${currentIndex + 1}. `) + q.q;

            // 表示リセット
            choiceContainer.classList.add('hidden');
            sortContainer.classList.add('hidden');
            document.getElementById('feedback-overlay').classList.add('hidden');
            // AI解説エリアのリセット
            document.getElementById('ai-response-area').classList.add('hidden');
            document.getElementById('btn-ask-ai').classList.remove('hidden');
            document.getElementById('btn-ask-ai').innerHTML = '<i class="fas fa-sparkles text-purple-500"></i> AI先生に詳しく聞く';
            document.getElementById('btn-ask-ai').disabled = false;

            if (q.type === 'choice') {
                setupChoiceQuestion(q);
            } else if (q.type === 'sort') {
                setupSortQuestion(q);
            }
        }

        // --- 4択問題のセットアップ ---
        function setupChoiceQuestion(q) {
            const container = document.getElementById('choice-container');
            container.innerHTML = '';
            container.classList.remove('hidden');

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white border border-gray-300 p-4 rounded-xl text-left hover:bg-indigo-50 hover:border-indigo-400 transition font-medium text-lg btn-bounce";
                btn.textContent = opt;
                btn.onclick = () => checkChoiceAnswer(idx);
                container.appendChild(btn);
            });
        }

        function checkChoiceAnswer(idx) {
            const q = currentQuestionData;
            userLastSelection = q.options[idx]; // 記録
            const isCorrect = (idx === q.a);
            showFeedback(isCorrect, q);
        }

        // --- 並べ替え問題のセットアップ ---
        function setupSortQuestion(q) {
            const container = document.getElementById('sort-container');
            container.classList.remove('hidden');
            
            currentSortAnswer = [];
            updateSortUI();

            // Word Bank 初期化（シャッフルして表示）
            const bank = document.getElementById('sort-word-bank');
            bank.innerHTML = '';
            
            // 単語リストをコピーしてシャッフル
            const shuffledWords = [...q.words];
            shuffleArray(shuffledWords);

            shuffledWords.forEach((word) => {
                const chip = document.createElement('button');
                chip.className = "bg-white border-2 border-gray-300 px-3 py-2 rounded-lg font-bold text-gray-700 shadow-sm sortable-word hover:border-indigo-400";
                chip.textContent = word;
                chip.dataset.word = word; // オリジナルの単語を保持
                chip.onclick = () => addWordToSort(word, chip);
                bank.appendChild(chip);
            });
        }

        function addWordToSort(word, chipElement) {
            // 既に選択済みなら何もしない（UI側で制御してもいいが念のため）
            if (chipElement.classList.contains('word-selected')) return;

            currentSortAnswer.push(word);
            chipElement.classList.add('word-selected', 'bg-gray-100', 'text-gray-300', 'border-gray-100'); // 視覚的に無効化
            updateSortUI();
        }

        function removeWordFromSort(index) {
            const removedWord = currentSortAnswer.splice(index, 1)[0];
            
            // Bankの該当チップを復活させる
            const chips = document.querySelectorAll('#sort-word-bank button');
            for (let chip of chips) {
                if (chip.dataset.word === removedWord && chip.classList.contains('word-selected')) {
                    chip.classList.remove('word-selected', 'bg-gray-100', 'text-gray-300', 'border-gray-100');
                    break; // 1つだけ復活
                }
            }
            updateSortUI();
        }

        function resetSort() {
            currentSortAnswer = [];
            // 全チップ復活
            const chips = document.querySelectorAll('#sort-word-bank button');
            chips.forEach(chip => {
                chip.classList.remove('word-selected', 'bg-gray-100', 'text-gray-300', 'border-gray-100');
            });
            updateSortUI();
        }

        function updateSortUI() {
            const area = document.getElementById('sort-answer-area');
            area.innerHTML = '';

            if (currentSortAnswer.length === 0) {
                area.innerHTML = '<span class="text-gray-400 text-sm w-full text-center pointer-events-none">単語をタップして並べよう</span>';
                return;
            }

            currentSortAnswer.forEach((word, idx) => {
                const span = document.createElement('span');
                span.className = "bg-indigo-100 text-indigo-800 px-2 py-1 rounded cursor-pointer hover:bg-red-100 hover:text-red-600 transition";
                span.textContent = word;
                span.onclick = () => removeWordFromSort(idx);
                area.appendChild(span);
            });
        }

        function checkSortAnswer() {
            const q = currentQuestionData;
            // 配列の内容比較
            const userAns = currentSortAnswer.join(' ');
            userLastSelection = userAns; // 記録
            const correctAns = q.correctOrder.join(' ');
            
            const isCorrect = (userAns === correctAns);
            showFeedback(isCorrect, q);
        }

        // --- フィードバック共通処理 ---
        function showFeedback(isCorrect, q) {
            const overlay = document.getElementById('feedback-overlay');
            const icon = document.getElementById('fb-icon');
            const title = document.getElementById('fb-title');
            const contentBox = document.getElementById('fb-content-box');
            const correctAnsDisplay = document.getElementById('fb-correct-answer');
            const explain = document.getElementById('fb-explain');

            overlay.classList.remove('hidden');
            
            if (isCorrect) {
                score++;
                document.getElementById('header-score').innerText = score;
                icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                title.textContent = "正解！";
                title.className = "text-3xl font-bold mb-4 text-green-600";
                contentBox.className = "w-full bg-green-50 p-4 rounded-lg border-l-4 border-green-500 mb-4";
            } else {
                icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                title.textContent = "不正解...";
                title.className = "text-3xl font-bold mb-4 text-red-600";
                contentBox.className = "w-full bg-red-50 p-4 rounded-lg border-l-4 border-red-500 mb-4";
            }

            // 正解表示の作成
            if (q.type === 'choice') {
                correctAnsDisplay.textContent = q.options[q.a];
            } else {
                correctAnsDisplay.textContent = q.correctOrder.join(' ');
            }
            
            explain.textContent = q.explain;
        }

        // --- AI 解説機能 ---
        async function askGeminiExplain() {
            const btn = document.getElementById('btn-ask-ai');
            const aiArea = document.getElementById('ai-response-area');
            const aiText = document.getElementById('ai-response-text');
            const q = currentQuestionData;
            const correctAns = q.type === 'choice' ? q.options[q.a] : q.correctOrder.join(' ');

            // Loading state
            btn.innerHTML = '<div class="loader mr-2" style="width:20px; height:20px; border-width:2px;"></div> 解説を作成中...';
            btn.disabled = true;

            try {
                const prompt = `
                あなたは日本の中学1年生に英語を教える優しく面白い先生です。
                以下の問題について、なぜその答えが正解なのか、なぜユーザーの答えが間違いなのかを、文法用語（3単現のsなど）を使って分かりやすく日本語で解説してください。
                口調は「〜だよ！」「〜だね」のように親しみやすく。
                
                問題: ${q.q}
                正解: ${correctAns}
                ユーザーの回答: ${userLastSelection}
                
                文字数: 150文字程度。
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                const explanation = data.candidates[0].content.parts[0].text;

                // Show result
                btn.classList.add('hidden'); // ボタンを隠す
                aiArea.classList.remove('hidden');
                aiArea.classList.add('ai-box-enter');
                aiText.textContent = explanation;

            } catch (e) {
                console.error(e);
                btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> エラーが発生しました';
                btn.disabled = false;
            }
        }

        async function nextQuestion() {
            if (currentMode === 'ai_infinite') {
                // 無限モードなら次の問題をロード
                document.getElementById('feedback-overlay').classList.add('hidden');
                await loadAIQuestion();
            } else {
                // 通常モード
                currentIndex++;
                if (currentIndex < questionQueue.length) {
                    loadQuestion();
                } else {
                    showResult();
                }
            }
        }

        function showResult() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');

            // 通常モードのスコア計算
            const finalScore = Math.round((score / questionQueue.length) * 100);
            document.getElementById('final-score-num').innerText = finalScore;

            setTimeout(() => {
                const offset = 351 - (351 * finalScore / 100);
                document.getElementById('score-circle').style.strokeDashoffset = offset;
                const circle = document.getElementById('score-circle');
                if(finalScore === 100) circle.setAttribute('stroke', '#fbbf24'); // gold
                else if(finalScore < 60) circle.setAttribute('stroke', '#ef4444'); // red
            }, 100);

            const title = document.getElementById('result-title');
            const msg = document.getElementById('result-msg');

            if (finalScore === 100) {
                title.textContent = "Perfect!!";
                title.className = "text-3xl font-bold mb-2 text-yellow-500";
                msg.textContent = "文句なしの100点です！テスト本番もこの調子で！";
            } else if (finalScore >= 80) {
                title.textContent = "Great Job!";
                title.className = "text-3xl font-bold mb-2 text-indigo-600";
                msg.textContent = "素晴らしい成績です。";
            } else if (finalScore >= 60) {
                title.textContent = "Good!";
                title.className = "text-3xl font-bold mb-2 text-green-600";
                msg.textContent = "合格圏内です！";
            } else {
                title.textContent = "Keep Trying!";
                title.className = "text-3xl font-bold mb-2 text-gray-600";
                msg.textContent = "復習してもう一度チャレンジしましょう。";
            }
        }

        // --- Utility ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

    </script>
</body>
</html>